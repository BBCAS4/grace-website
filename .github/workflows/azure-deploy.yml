name: Deploy to Azure

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: GraceIntegratedHealth
  NODE_VERSION: '22.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Clean Next.js cache
      run: rm -rf .next

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production

    - name: Prepare deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy
        
        # First, let's see what the standalone output contains
        echo "=== Standalone output structure ==="
        ls -la .next/standalone/
        
        # Copy everything from standalone to deploy root
        cp -r .next/standalone/. deploy/
        
        # Copy static files to .next/static in deploy
        if [ -d ".next/static" ]; then
          mkdir -p deploy/.next/static
          cp -r .next/static/. deploy/.next/static/
        fi
        
        # Copy public folder
        if [ -d "public" ]; then
          cp -r public/. deploy/public/
        fi
        
        # Verify the deployment structure
        echo "=== Final deployment structure ==="
        ls -la deploy/
        echo "=== Looking for server.js ==="
        find deploy/ -name "server.js" -type f
        echo "=== Looking for package.json ==="
        find deploy/ -name "package.json" -type f
        echo "=== Contents of deploy/.next ==="
        ls -la deploy/.next/ 2>/dev/null || echo "No .next directory in deploy"
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_DDF023C7D7B0465B84F3A47376108CA2 }}
        tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_5F7C28C114FE45DE9CC82199A8F55F54 }}
        subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_49CD86B012FB4ACAAB6D7BD86F1F724F }}
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        slot-name: 'Production'
        package: ./deploy

